name: CI

on:
  push:
    branches: [ main, feat/*, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ==========================================================================
  # Primary build + test matrix
  # ==========================================================================
  build-test:
    name: Build & Test (${{ matrix.os }}, ${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Safe-SIMD builds (no asm)
          - os: ubuntu-latest
            features: "bitdepth_8,bitdepth_16"
            label: safe-simd
          - os: windows-latest
            features: "bitdepth_8,bitdepth_16"
            label: safe-simd
          - os: macos-latest
            features: "bitdepth_8,bitdepth_16"
            label: safe-simd

          # ASM builds (original hand-written assembly, x86_64 only)
          - os: ubuntu-latest
            features: "asm,bitdepth_8,bitdepth_16"
            label: asm

          # 32-bit builds (safe-simd, no SIMD dispatch — exercises scalar paths)
          - os: ubuntu-latest
            features: "bitdepth_8,bitdepth_16"
            label: i686
            target: i686-unknown-linux-gnu
          - os: windows-latest
            features: "bitdepth_8,bitdepth_16"
            label: i686
            target: i686-pc-windows-msvc

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install target
        if: matrix.target
        run: rustup target add ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2

      - name: Install NASM (Linux)
        if: runner.os == 'Linux' && contains(matrix.features, 'asm')
        run: sudo apt-get update && sudo apt-get install -y nasm

      - name: Install NASM (macOS)
        if: runner.os == 'macOS' && contains(matrix.features, 'asm')
        run: brew install nasm

      - name: Install NASM (Windows)
        if: runner.os == 'Windows' && contains(matrix.features, 'asm')
        run: choco install nasm

      - name: Install 32-bit toolchain (Linux)
        if: matrix.label == 'i686' && runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y gcc-multilib

      - name: Build (debug)
        run: cargo build --no-default-features --features "${{ matrix.features }}" ${{ matrix.target && format('--target {0}', matrix.target) || '' }}

      - name: Build (release)
        run: cargo build --no-default-features --features "${{ matrix.features }}" --release ${{ matrix.target && format('--target {0}', matrix.target) || '' }}

      - name: Run unit tests
        run: cargo test --no-default-features --features "${{ matrix.features }}" --release --lib ${{ matrix.target && format('--target {0}', matrix.target) || '' }}

      # Download test vectors and run MD5 parity tests
      - name: Download test vectors
        if: matrix.label == 'safe-simd' && runner.os == 'Linux'
        run: bash scripts/download-test-vectors.sh
        continue-on-error: true

      - name: Run MD5 decode parity tests
        if: matrix.label == 'safe-simd' && runner.os == 'Linux'
        run: cargo test --no-default-features --features "${{ matrix.features }}" --release --test decode_md5_verify
        continue-on-error: true

  # ==========================================================================
  # Clippy lint check
  # ==========================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2

      # Safe-SIMD build (strict — must pass)
      - name: Clippy (safe-simd)
        run: cargo clippy --no-default-features --features "bitdepth_8,bitdepth_16" -- -D warnings

      # C-FFI build (strict — must pass)
      - name: Clippy (c-ffi)
        run: cargo clippy --no-default-features --features "c-ffi,bitdepth_8,bitdepth_16" -- -D warnings

  # ==========================================================================
  # Format check
  # ==========================================================================
  format:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        run: cargo fmt --all -- --check

  # ==========================================================================
  # Cross-compile checks (build only, no tests)
  # ==========================================================================
  cross-compile:
    name: Cross-compile (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-musl
          - aarch64-unknown-linux-gnu
          - wasm32-wasip1
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - name: Check (aarch64)
        if: contains(matrix.target, 'aarch64')
        run: cargo check --target ${{ matrix.target }} --no-default-features --features "bitdepth_8,bitdepth_16"
      - name: Check (wasm32 simd128)
        if: contains(matrix.target, 'wasm32')
        run: RUSTFLAGS="-Ctarget-feature=+simd128" cargo check --target ${{ matrix.target }} --no-default-features --features "bitdepth_8,bitdepth_16"
      - name: Build (non-aarch64, non-wasm)
        if: "!contains(matrix.target, 'aarch64') && !contains(matrix.target, 'wasm32')"
        run: cargo build --target ${{ matrix.target }} --no-default-features --features "bitdepth_8,bitdepth_16"

  # ==========================================================================
  # Token permutation tests (exercises all SIMD tiers)
  # ==========================================================================
  permutation-tests:
    name: SIMD Permutation Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run unit permutation tests
        run: cargo test --no-default-features --features "bitdepth_8,bitdepth_16" --release --lib -- --test-threads=1 token_permutation

  # ==========================================================================
  # Code coverage
  # ==========================================================================
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Generate coverage
        run: cargo llvm-cov --no-default-features --features "bitdepth_8,bitdepth_16" --lib --lcov --output-path lcov.info
      - name: Upload to codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          fail_ci_if_error: false
